version: '3.9'

services:
  # RAG Backend - FastAPI Service
  rag-backend:
    build:
      context: ./rag-backend
      dockerfile: Dockerfile
    container_name: rag-chatbot-backend
    ports:
      - "8000:8000"
    environment:
      # FastAPI Configuration
      DEBUG: "true"
      HOST: "0.0.0.0"
      PORT: "8000"
      ENVIRONMENT: "development"

      # OpenAI Configuration
      OPENAI_API_KEY: ${OPENAI_API_KEY:-sk-test-key-placeholder}
      OPENAI_EMBEDDING_MODEL: "text-embedding-3-small"
      OPENAI_LLM_MODEL: "gpt-4o"
      OPENAI_LLM_FALLBACK_MODEL: "gpt-3.5-turbo"
      OPENAI_TEMPERATURE: "0.3"
      OPENAI_MAX_TOKENS: "500"

      # Qdrant Configuration
      QDRANT_URL: ${QDRANT_URL:-https://localhost:6333}
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
      QDRANT_COLLECTION_NAME: "book_v1.0_chapters"

      # Neon Postgres Configuration
      DATABASE_URL: ${DATABASE_URL:-postgresql://localhost/rag_chatbot}

      # Chat Configuration
      RATE_LIMIT_QUERIES_PER_MINUTE: "10"
      SESSION_TIMEOUT_HOURS: "24"
      MAX_SELECTED_TEXT_TOKENS: "2000"
      MAX_SELECTED_TEXT_CHARACTERS: "10000"

      # CORS Configuration
      ALLOWED_ORIGINS_STR: "http://localhost:3000,http://localhost:8000,http://localhost:5173"

      # Logging
      LOG_LEVEL: "INFO"

    volumes:
      - ./rag-backend/src:/app/src
      - ./rag-backend/tests:/app/tests

    depends_on:
      - postgres

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    restart: unless-stopped
    networks:
      - rag-network

  # PostgreSQL Database (Neon locally)
  postgres:
    image: postgres:15-alpine
    container_name: rag-chatbot-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: rag_chatbot

    ports:
      - "5432:5432"

    volumes:
      - postgres_data:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

    restart: unless-stopped
    networks:
      - rag-network

volumes:
  postgres_data:
    driver: local

networks:
  rag-network:
    driver: bridge

# Usage:
# 1. Copy .env.example to .env and fill in credentials
# 2. Run: docker-compose up -d
# 3. Access API: http://localhost:8000/docs
# 4. Run tests: docker-compose exec rag-backend pytest tests/ -v
# 5. View logs: docker-compose logs -f rag-backend
# 6. Stop: docker-compose down
